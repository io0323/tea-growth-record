# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Scala CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        cache: 'sbt'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Verify Node.js and npm
      run: |
        node --version
        npm --version
        which npm
        
    - name: Install npm (explicit)
      run: |
        npm install -g npm@9.8.1
        npm --version
        
    - name: Clear caches
      run: |
        npm cache clean --force
        rm -rf ~/.sbt
        rm -rf ~/.ivy2/cache
        
    - name: Install sbt
      run: |
        echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list
        curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x99E82A75642AC823" | sudo apt-key add
        sudo apt-get update
        sudo apt-get install sbt
        
    - name: Cache sbt dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.sbt
          ~/.ivy2/cache
          ~/.coursier/cache/v1
          project/target
          target
        key: ${{ runner.os }}-sbt-${{ hashFiles('**/*.sbt') }}-${{ hashFiles('**/project/build.properties') }}
        restore-keys: |
          ${{ runner.os }}-sbt-${{ hashFiles('**/*.sbt') }}-
          ${{ runner.os }}-sbt-
          
    - name: Run tests (Root project)
      run: |
        export PATH="/usr/local/bin:$PATH"
        sbt test
        
    - name: Run tests (Server project)
      run: |
        export PATH="/usr/local/bin:$PATH"
        cd server && sbt test
        
    - name: Compile (Root project)
      run: |
        export PATH="/usr/local/bin:$PATH"
        sbt compile
        
    - name: Compile (Server project)
      run: |
        export PATH="/usr/local/bin:$PATH"
        cd server && sbt compile
      
    - name: Upload dependency graph
      uses: scalacenter/sbt-dependency-submission@ab086b50c947c9774b70f39fc7f6e20ca2706c91
